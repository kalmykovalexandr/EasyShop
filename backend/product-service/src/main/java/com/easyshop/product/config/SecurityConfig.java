package com.easyshop.product.config;import jakarta.servlet.*;import jakarta.servlet.http.*;import org.springframework.beans.factory.annotation.*;import org.springframework.context.annotation.*;import org.springframework.http.*;import org.springframework.security.authentication.*;import org.springframework.security.config.annotation.web.builders.*;import org.springframework.security.config.http.*;import org.springframework.security.core.authority.*;import org.springframework.security.web.*;import org.springframework.security.web.authentication.www.*;import io.jsonwebtoken.*;import io.jsonwebtoken.io.*;import io.jsonwebtoken.security.*;import java.io.*;import java.security.*;import java.util.*;@Configuration public class SecurityConfig{@Value("${jwt.secret}") String secret;Key key(){return Keys.hmacShaKeyFor(Decoders.BASE64.decode(secret));}@Bean SecurityFilterChain c(HttpSecurity h)throws Exception{h.csrf(cs->cs.disable()).sessionManagement(sm->sm.sessionCreationPolicy(SessionCreationPolicy.STATELESS)).authorizeHttpRequests(r->r.requestMatchers("/healthz","/readyz","/api/products/**").permitAll().requestMatchers("/api/admin/**").hasRole("ADMIN").anyRequest().authenticated()).addFilterBefore((req,res,chain)->auth(req,res,chain), BasicAuthenticationFilter.class);return h.build();}void auth(HttpServletRequest req,HttpServletResponse res,FilterChain chain)throws IOException{String a=req.getHeader(HttpHeaders.AUTHORIZATION);if(a!=null&&a.startsWith("Bearer ")){try{Jws<Claims> j=Jwts.parserBuilder().setSigningKey(key()).build().parseClaimsJws(a.substring(7));String role=String.valueOf(j.getBody().get("role"));var token=new AbstractAuthenticationToken(List.of(new SimpleGrantedAuthority("ROLE_"+role))){public Object getCredentials(){return "";}public Object getPrincipal(){return j.getBody().getSubject();}{setAuthenticated(true);}};org.springframework.security.core.context.SecurityContextHolder.getContext().setAuthentication(token);}catch(Exception ignore){}}try{chain.doFilter(req,res);}catch(Exception e){throw new IOException(e);}}}
